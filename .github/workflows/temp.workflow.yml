# название схемы заданий
name: temp-workflow
# название инстанса схемы заданий (если не указать, то вместо будет отображаться заголовок коммита)
run-name: temp-runner

on:
  # при каком событии выполнять
  push:
    branches:
      - main
      - master

jobs:
  # описание группы заданий
  building-and-packing:
    # операционная система, в которой будут выполняться задания
    runs-on: ubuntu-latest

    # задания
    steps:
      # копируем код проекта в виртуальную машину
      - name: Checkout Repository
        uses: actions/checkout@v4

      # устанавливаем docker-compose
      - name: Set up Docker Compose
        uses: ndeloof/install-compose-action@v0.0.1

      # запускаем docker-compose файл, разворачиваем контейнеры в product mode
      - name: Deploy with Docker Compose
        run: |
          docker-compose -f devops/docker-compose-prod.yml --env-file env/.env.prod up -d

      # сохраняем образ сборки для загрузки с удаленного сервера и запуска из docker-compose по ссылке
      - name: Publish to Registry
        uses: elgohr/Publish-Docker-Github-Action@v5
        with:
          # хранилище docker images на гитхабе
          registry: docker.pkg.github.com
          name: docker.pkg.github.com/GRD-1/Nest-guide

          # расположение докерфайла (если он не в корне)
          dockerfile: devops/Dockerfile-prod.yml

          # учетные данные для доступа к образу (прописываются в настройках гитхаба)
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # останавливаем докер контейнеры (иначе задача будет выполняться бесконечно)
      - name: stop docker containers and quit
        run: |
          docker stop $(docker ps -aq)
